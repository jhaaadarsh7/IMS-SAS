generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  role          UserRole
  branchIds     String[]  @default([])
  isActive      Boolean   @default(true)
  refreshToken  String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
}

enum UserRole {
  SUPER_ADMIN
  HQ_MANAGER
  BRANCH_MANAGER
  INVENTORY_CLERK
  SALES_USER
  VIEWER
}

model Warehouse {
  id          String      @id @default(cuid())
  code        String      @unique
  name        String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  stockLedger StockLedger[]
}

model Branch {
  id          String      @id @default(cuid())
  code        String      @unique
  name        String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  stockLedger StockLedger[]
  forecasts   Forecast[]
  abcClasses  ABCClass[]
}

model Product {
  id          String      @id @default(cuid())
  sku         String      @unique
  name        String
  unitCost    Decimal     @db.Decimal(12, 2)
  sellingPrice Decimal    @db.Decimal(12, 2)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  stockLedger StockLedger[]
  forecasts   Forecast[]
  abcClasses  ABCClass[]
}

model StockLedger {
  id             BigInt    @id @default(autoincrement())
  eventType      LedgerEventType
  quantityDelta  Int
  referenceNo    String?
  notes          String?
  productId      String
  product        Product   @relation(fields: [productId], references: [id])
  warehouseId    String?
  warehouse      Warehouse? @relation(fields: [warehouseId], references: [id])
  branchId       String?
  branch         Branch?   @relation(fields: [branchId], references: [id])
  createdAt      DateTime  @default(now())

  @@index([productId, createdAt])
  @@index([branchId, productId, createdAt])
  @@index([warehouseId, productId, createdAt])
  @@index([eventType, createdAt])
}

model Forecast {
  id            String    @id @default(cuid())
  productId     String
  product       Product   @relation(fields: [productId], references: [id])
  branchId      String?
  branch        Branch?   @relation(fields: [branchId], references: [id])
  model         String
  horizonDays   Int
  forecastQty   Decimal   @db.Decimal(12, 2)
  confidence    Decimal?  @db.Decimal(5, 2)
  createdAt     DateTime  @default(now())

  @@index([productId, branchId, createdAt])
}

model ABCClass {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  branchId    String?
  branch      Branch?  @relation(fields: [branchId], references: [id])
  class       ABCRank
  annualValue Decimal  @db.Decimal(14, 2)
  period      String
  createdAt   DateTime @default(now())

  @@index([branchId, class, createdAt])
  @@index([productId, period])
}

enum LedgerEventType {
  PURCHASE_IN
  TRANSFER_OUT_WAREHOUSE
  TRANSFER_IN_BRANCH
  SALE_OUT_BRANCH
  ADJUSTMENT_POSITIVE
  ADJUSTMENT_NEGATIVE
}

enum ABCRank {
  A
  B
  C
}
